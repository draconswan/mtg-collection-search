<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Deck Checklist</title>
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
    />
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
            integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd"
            crossorigin="anonymous"
    />
    <style>
        @media print {
            .form-check-input { visibility: hidden; }
        }
    </style>
    <script>
        function exportUncheckedCards() {
            const includeX = document.getElementById('includeX').checked;
            const unchecked = Array.from(document.getElementById('decklistForm').querySelectorAll('.form-check-input'))
               .filter(input => !input.checked)
               .map(input => {
                   const label = document.querySelector(`label[for="${input.id}"]`);
                   if (!label) return '';

                   const labelText = label.textContent.trim();
                   const match = labelText.match(/^(\d+)x?\s+(.*)$/);

                   if (match) {
                       const quantity = match[1];
                       const name = match[2];
                       return includeX ? `${quantity}x ${name}` : `${quantity} ${name}`;
                   } else {
                       return labelText;
                   }
               });

            const outputArea = document.getElementById('outputArea');
            outputArea.value = unchecked.length > 0 ? unchecked.join('\n') : "All cards are checked!";
        }

        function clearUncheckedCards() {
            const outputArea = document.getElementById('outputArea');
            outputArea.value = "";
        }
    </script>
</head>
<body>
<!-- Include header -->
<div th:replace="~{fragments/header :: body}"></div>
<div class="container py-4">
    <h1 class="mb-4">Deck Checklist</h1>
    <h6 class="text-muted" th:text="'Total cards: ' + ${totalQuantity}"></h6>
    <div class="row">
        <!-- Left Column: Checklist -->
        <div class="col-md-6">
            <form id="decklistForm">
                <div class="row g-1">
                    <div th:each="entryGroup : ${groupedDecklist}">
                        <h5 class="mt-4 mb-2" th:text="${entryGroup.key + ' (' + typeQuantities[entryGroup.key] + ')'}"></h5>

                        <div th:each="cardEntry : ${entryGroup.value}" class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   th:id="${#strings.replace(cardEntry.card.name, '[^a-zA-Z0-9]', '_')}" />
                            <label class="form-check-label"
                                   th:for="${#strings.replace(cardEntry.card.name, '[^a-zA-Z0-9]', '_')}"
                                   th:text="${cardEntry.quantity + ' ' + cardEntry.card.name}"></label>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Right Column: Output Text Area -->
        <div class="col-md-6">
            <div class="form-check">
                <input class="form-check-input d-not-include" type="checkbox" id="includeX" checked/>
                <label class="form-check-label" for="includeX">Include "x" in quantity</label>
            </div>
            <button type="button" class="btn btn-outline-primary" onclick="exportUncheckedCards()">Export Unchecked
                Cards
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="clearUncheckedCards()">Clear</button>
            <textarea id="outputArea" class="form-control mt-2" rows="20" readonly></textarea>
        </div>
    </div>
</div>
</body>
</html>
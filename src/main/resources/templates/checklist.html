<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
    <title>Card Checklist</title>
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
    />
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
            integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd"
            crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/print.css" media="print"/>
    <link rel="stylesheet" href="/css/style.css"/>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const ownedBoxes = document.querySelectorAll("input.owned[data-name]");
            const notFoundBoxes = document.querySelectorAll("input.not-found[data-name]");

            // Sync all "Owned" checkboxes with the same card name
            ownedBoxes.forEach(box => {
                box.addEventListener("change", function () {
                    const name = this.dataset.name;
                    ownedBoxes.forEach(other => {
                        if (other !== this && other.dataset.name === name) {
                            other.checked = this.checked;
                        }
                    });
                    if (this.checked) {
                        notFoundBoxes.forEach(other => {
                            if (other.dataset.name === name) {
                                other.checked = false;
                            }
                        });
                    }
                });
            });

            // Make "Not Found" mutually exclusive with its paired "Owned" checkbox only
            notFoundBoxes.forEach(box => {
                box.addEventListener("change", function () {
                    const name = this.dataset.name;
                    const row = this.closest("tr");
                    const owned = row.querySelector("input.owned[data-name='" + name + "']");
                    if (this.checked && owned) {
                        owned.checked = false;
                    }
                });
            });
        });
    </script>
    <script>
        function toggleLayout() {
            const columns = document.querySelectorAll(".checklist-column");
            columns.forEach(col => {
                if (col.classList.contains("col-md-6")) {
                    col.classList.remove("col-12", "col-md-6", "col-lg-4");
                    col.classList.add("col-12");
                } else {
                    col.classList.remove("col-12");
                    col.classList.add("col-12", "col-md-6", "col-lg-4");
                }
            });
        }

        function filterCardsByType() {
            const checkedTypes = Array.from(document.querySelectorAll('#typeFilterDiv input[type="checkbox"]:checked'))
                .map(cb => cb.value.toUpperCase());

            const rows = document.querySelectorAll('table tbody tr');
            rows.forEach(row => {
                const types = row.dataset.types ? row.dataset.types.toUpperCase().split(',') : [];
                const isVisible = types.some(type => checkedTypes.includes(type));
                row.style.display = isVisible ? '' : 'none';
            });

            // Hide entire set group if all its rows are hidden
            const setGroups = document.querySelectorAll('.checklist-column');
            setGroups.forEach(group => {
                const visibleRows = group.querySelectorAll('tbody tr:not([style*="display: none"])');
                group.style.display = visibleRows.length > 0 ? '' : 'none';
            });
        }
        document.addEventListener('DOMContentLoaded', filterCardsByType);
    </script>
</head>
<body class="container my-4">
<h1 class="mb-4">Card Checklist</h1>
<button class="btn btn-primary d-print-none mb-3" onclick="window.print()">üñ®Ô∏è Print Checklist</button>
<button class="btn btn-secondary mb-3 d-print-none" onclick="toggleLayout()">üß© Toggle Layout</button>
<div id="typeFilterDiv" class="mb-3 d-print-none">
    <label class="form-label">Show Card Types:</label><br/>
    <th:block th:each="type : ${cardTypes}">
        <div class="form-check form-check-inline">
            <input class="form-check-input typeCheckbox" type="checkbox"
                   th:id="${'type_' + type.name()}"
                   th:value="${type.name()}"
                   th:checked="true"
                   onchange="filterCardsByType()"/>
            <label class="form-check-label" th:for="${'type_' + type.name()}"
                   th:text="${type.name().toLowerCase().replace('_', ' ')}"></label>
        </div>
    </th:block>
</div>
<div class="row" id="checklist-grid">
    <div th:each="set : ${cardSets}" class="col-12 col-md-6 col-lg-4 mb-5 checklist-column">
        <!-- Set header -->
        <h2 th:text="${set.setName + ' (' + set.setCode.toUpperCase() + ')'}" class="mb-3 set-title"></h2>
        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-sm align-middle">
                <thead class="table-light">
                <tr>
                    <th scope="col" class="checkbox-col text-center" aria-label="Owned">
                        <i class="bi bi-check-circle-fill text-success" title="Owned"></i>
                    </th>
                    <th scope="col" class="checkbox-col text-center" aria-label="Not Found">
                        <i class="bi bi-x-circle-fill text-danger" title="Not Found"></i>
                    </th>
                    <th scope="col">Card Name</th>
                    <th scope="col" class="rarity-col">Rarity</th>
                    <th scope="col" class="color-col">Color</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="card : ${set.cards}" th:attr="data-types=${#strings.listJoin(card.card_types.cardType, ',')}">
                    <td class="checkbox-col text-center">
                        <input type="checkbox"
                               class="form-check-input owned"
                               th:id="'owned-' + ${card.id}"
                               th:attr="data-name=${card.name}"/>
                        <label th:for="'owned-' + ${card.id}" class="visually-hidden">
                            Owned for [[${card.name}]]
                        </label>
                    </td>
                    <td class="checkbox-col text-center">
                        <input type="checkbox"
                               class="form-check-input not-found"
                               th:id="'notfound-' + ${card.id}"
                               th:attr="data-name=${card.name}"/>
                        <label th:for="'notfound-' + ${card.id}" class="visually-hidden">
                            Not Found for [[${card.name}]]
                        </label>
                    </td>
                    <td th:text="${card.name}"></td>
                    <td th:text="${card.rarity}" class="rarity-col"></td>
                    <td th:text="${card.color}" class="color-col"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
<footer>
    <div class="d-none d-print-block text-center mb-4">
        <strong>Magic Checklist</strong><br/>
        <span th:text="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"></span>
    </div>
</footer>
</html>
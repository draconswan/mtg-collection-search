<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
    <title>Card Checklist</title>
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
    />
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
            integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd"
            crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/print.css" media="print"/>
    <link rel="stylesheet" href="/css/style.css"/>
    <script>
        const manaSymbolMap = {
            W: "https://svgs.scryfall.io/card-symbols/W.svg",
            U: "https://svgs.scryfall.io/card-symbols/U.svg",
            B: "https://svgs.scryfall.io/card-symbols/B.svg",
            R: "https://svgs.scryfall.io/card-symbols/R.svg",
            G: "https://svgs.scryfall.io/card-symbols/G.svg",
            C: "https://svgs.scryfall.io/card-symbols/C.svg",
            0: "https://svgs.scryfall.io/card-symbols/0.svg",
            1: "https://svgs.scryfall.io/card-symbols/1.svg",
            2: "https://svgs.scryfall.io/card-symbols/2.svg",
            3: "https://svgs.scryfall.io/card-symbols/3.svg",
            4: "https://svgs.scryfall.io/card-symbols/4.svg",
            5: "https://svgs.scryfall.io/card-symbols/5.svg",
            6: "https://svgs.scryfall.io/card-symbols/6.svg",
            7: "https://svgs.scryfall.io/card-symbols/7.svg",
            8: "https://svgs.scryfall.io/card-symbols/8.svg",
            9: "https://svgs.scryfall.io/card-symbols/9.svg",
            10: "https://svgs.scryfall.io/card-symbols/10.svg",
            11: "https://svgs.scryfall.io/card-symbols/11.svg",
            12: "https://svgs.scryfall.io/card-symbols/12.svg",
            13: "https://svgs.scryfall.io/card-symbols/13.svg",
            14: "https://svgs.scryfall.io/card-symbols/14.svg",
            15: "https://svgs.scryfall.io/card-symbols/15.svg",
            16: "https://svgs.scryfall.io/card-symbols/16.svg",
            17: "https://svgs.scryfall.io/card-symbols/17.svg",
            18: "https://svgs.scryfall.io/card-symbols/18.svg",
            19: "https://svgs.scryfall.io/card-symbols/19.svg",
            20: "https://svgs.scryfall.io/card-symbols/20.svg",
        };

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll("td.color-col").forEach(cell => {
                let colorText = cell.textContent.trim();
                // Default to "C" if empty
                if (!colorText) {
                    colorText = "C";
                }
                cell.textContent = ""; // Clear existing text

                [...colorText].forEach(char => {
                    const symbol = manaSymbolMap[char];
                    if (symbol) {
                        const img = document.createElement("img");
                        img.src = symbol;
                        img.alt = char;
                        img.width = 20;
                        img.height = 20;
                        img.style.marginRight = "4px";
                        img.style.verticalAlign = "middle";
                        cell.appendChild(img);
                    } else {
                        cell.appendChild(document.createTextNode(char));
                    }
                });
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            const ownedBoxes = document.querySelectorAll("input.owned[data-name]");
            const notFoundBoxes = document.querySelectorAll("input.not-found[data-name]");

            // Sync all "Owned" checkboxes with the same card name
            ownedBoxes.forEach(box => {
                box.addEventListener("change", function () {
                    const name = this.dataset.name;
                    ownedBoxes.forEach(other => {
                        if (other !== this && other.dataset.name === name) {
                            other.checked = this.checked;
                        }
                    });
                    if (this.checked) {
                        notFoundBoxes.forEach(other => {
                            if (other.dataset.name === name) {
                                other.checked = false;
                            }
                        });
                    }
                });
            });

            // Make "Not Found" mutually exclusive with its paired "Owned" checkbox only
            notFoundBoxes.forEach(box => {
                box.addEventListener("change", function () {
                    const name = this.dataset.name;
                    const row = this.closest("tr");
                    const owned = row.querySelector("input.owned[data-name='" + name + "']");
                    if (this.checked && owned) {
                        owned.checked = false;
                    }
                });
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const preview = document.getElementById('card-preview');
            const cache = {}; // simple in-memory cache

            document.querySelectorAll('.card-link').forEach(link => {
                link.addEventListener('mouseenter', e => {
                    const imgUrl = link.getAttribute('data-img-url');

                    // if cached, reuse immediately
                    if (cache[imgUrl]) {
                        preview.innerHTML = cache[imgUrl];
                        preview.style.display = 'block';
                    } else {
                        // debounce: only fetch once
                        const img = new Image();
                        img.src = imgUrl;
                        img.alt = 'Card image';
                        img.style.maxWidth = '200px';
                        img.onload = () => {
                            const html = `<img src="${imgUrl}" alt="Card image" style="max-width:200px;">`;
                            cache[imgUrl] = html; // store in cache
                            preview.innerHTML = html;
                            preview.style.display = 'block';
                        };
                    }
                });

                link.addEventListener('mousemove', e => {
                    preview.style.top = (e.pageY + 15) + 'px';
                    preview.style.left = (e.pageX + 15) + 'px';
                });

                link.addEventListener('mouseleave', () => {
                    preview.style.display = 'none';
                });
            });
        });
    </script>
    <script>
        function toggleLayout() {
            const columns = document.querySelectorAll(".checklist-column");
            columns.forEach(col => {
                if (col.classList.contains("col-md-6")) {
                    col.classList.remove("col-12", "col-md-6", "col-lg-4");
                    col.classList.add("col-12");
                } else {
                    col.classList.remove("col-12");
                    col.classList.add("col-12", "col-md-6", "col-lg-4");
                }
            });
        }

        function filterCardsByType() {
            const checkedTypes = Array.from(document.querySelectorAll('#typeFilterDiv input[type="checkbox"]:checked'))
                .map(cb => cb.value.toUpperCase());

            const rows = document.querySelectorAll('table tbody tr');
            rows.forEach(row => {
                const types = row.dataset.types ? row.dataset.types.toUpperCase().split(',') : [];
                const isVisible = types.some(type => checkedTypes.includes(type));
                row.style.display = isVisible ? '' : 'none';
            });

            // Hide entire set group if all its rows are hidden
            const setGroups = document.querySelectorAll('.checklist-column');
            setGroups.forEach(group => {
                const visibleRows = group.querySelectorAll('tbody tr:not([style*="display: none"])');
                group.style.display = visibleRows.length > 0 ? '' : 'none';
            });
        }
        document.addEventListener('DOMContentLoaded', filterCardsByType);
    </script>
</head>
<body class="container my-4">
<!-- Include header -->
<div th:replace="~{fragments/header :: body}"></div>
<h1 class="mb-4">Card Checklist</h1>
<button class="btn btn-primary d-print-none mb-3" onclick="window.print()">üñ®Ô∏è Print Checklist</button>
<button class="btn btn-secondary mb-3 d-print-none" onclick="toggleLayout()">üß© Toggle Layout</button>
<div id="typeFilterDiv" class="mb-3 d-print-none">
    <label class="form-label">Show Card Types:</label><br/>
    <th:block th:each="type : ${cardTypes}">
        <div class="form-check form-check-inline">
            <input class="form-check-input typeCheckbox" type="checkbox"
                   th:id="${'type_' + type.name()}"
                   th:value="${type.name()}"
                   th:checked="true"
                   onchange="filterCardsByType()"/>
            <label class="form-check-label" th:for="${'type_' + type.name()}"
                   th:text="${type.name().toLowerCase().replace('_', ' ')}"></label>
        </div>
    </th:block>
</div>
<div class="row" id="checklist-grid">
    <div id="card-preview"></div>
    <div th:each="set : ${cardSets}" class="set-group col-12 col-md-6 col-lg-6 mb-5 checklist-column">
        <!-- Set header -->
        <h2 th:text="${set.setName + ' (' + set.setCode.toUpperCase() + ')'}" class="mb-3 set-title"></h2>
        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-sm align-middle">
                <thead class="table-light">
                <tr>
                    <th scope="col" class="checkbox-col text-center" aria-label="Owned">
                        <i class="bi bi-check-circle-fill text-success" title="Owned"></i>
                    </th>
                    <th scope="col" class="checkbox-col text-center" aria-label="Not Found">
                        <i class="bi bi-x-circle-fill text-danger" title="Not Found"></i>
                    </th>
                    <th scope="col">Card Name</th>
                    <th scope="col" class="rarity-col">Rarity</th>
                    <th scope="col" class="color-col">Casting Cost/Color Identity</th>
                    <th scope="col" class="price-col">Prices</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="card : ${set.cards}"
                    th:attr="data-types=${#strings.listJoin(card.card_types.cardType, ',')}">
                    <td class="checkbox-col text-center">
                        <input type="checkbox"
                               class="form-check-input owned"
                               th:id="'owned-' + ${card.id}"
                               th:attr="data-name=${card.name}"/>
                        <label th:for="'owned-' + ${card.id}" class="visually-hidden">
                            Owned for [[${card.name}]]
                        </label>
                    </td>
                    <td class="checkbox-col text-center">
                        <input type="checkbox"
                               class="form-check-input not-found"
                               th:id="'notfound-' + ${card.id}"
                               th:attr="data-name=${card.name}"/>
                        <label th:for="'notfound-' + ${card.id}" class="visually-hidden">
                            Not Found for [[${card.name}]]
                        </label>
                    </td>
                    <td class="card-col">
                        <a th:href="${card.scryfall_uri}"
                           th:text="${card.name}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="card-link"
                           th:attr="data-img-url=${card.image_uris.normal}"></a>
                    </td>
                    <td th:text="${card.rarity}" class="rarity-col"></td>
                    <td th:text="${card.castingCostAndIdentity}" class="color-col"></td>
                    <td class="price-col">
                        <span th:if="${card.prices.usd != null}">
                            Normal: $<span th:text="${card.prices.usd}"></span><br/>
                        </span>
                        <span th:if="${card.prices.usd_foil != null}">
                            Foil: $<span th:text="${card.prices.usd_foil}"></span><br/>
                        </span>
                        <span th:if="${card.prices.usd_etched != null}">
                            Etched: $<span th:text="${card.prices.usd_etched}"></span>
                        </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
<footer>
    <div class="d-none d-print-block text-center mb-4">
        <strong>Magic Checklist</strong><br/>
        <span th:text="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"></span>
    </div>
</footer>
</html>
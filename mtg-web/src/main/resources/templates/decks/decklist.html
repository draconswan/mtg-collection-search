<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Deck Checklist</title>
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
    />
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
            integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd"
            crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/print.css" media="print"/>
    <link rel="stylesheet" href="/css/style.css"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
    <script src="/js/mana-symbols.js" defer></script>
    <script src="/js/deck.js"></script>
</head>
<body>
<!-- Include header -->
<div th:replace="~{fragments/header :: body}"></div>
<div class="container py-4">
    <div th:if="${cardsNotFound != null and !cardsNotFound.isEmpty()}"
         class="alert alert-danger d-flex align-items-start" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>Some cards could not be found:</strong>
            <ul class="mb-0">
                <li th:each="card : ${cardsNotFound}" th:text="${card}"></li>
            </ul>
        </div>
    </div>
    <h1 class="mb-4">Deck Checklist</h1>
    <div class="row">
        <h5>Add Card to Deck</h5>
        <div class="position-relative col-sm-10">
            <input type="text"
                   id="cardSearch"
                   class="form-control"
                   placeholder="Search card nameâ€¦"
                   autocomplete="off">
            <div id="cardSearchResults"
                 class="list-group position-absolute w-100 shadow-sm"
                 style="z-index: 1000; display: none;">
            </div>
        </div>
        <div class="col-sm-2">
            <button id="addSelectedCardBtn" class="btn btn-success" type="button">
                Add Selected Card
            </button>
        </div>
        <div id="addCardMessage" class="text-success small mt-1"></div>
    </div>
    <div class="row">
        <!-- Left Column: Checklist -->
        <div class="col-12">
            <form id="saveDeckForm"
                  th:object="${deckStateForm}"
                  th:action="@{/user/deck/save-deck-state}"
                  method="post">
                <input type="hidden" name="deckId" th:value="${deckId}"/>
                <div class="row mb-3">
                    <div class="col-lg-3 col-sm-6">
                        <label for="deckName" class="form-label">Deck Name</label>
                        <input type="text"
                               id="deckName"
                               name="deckName"
                               class="form-control"
                               th:value="${deckName}">
                    </div>
                    <div class="col-lg-3 col-sm-6">
                        <label for="deckFormat" class="form-label">Format</label>
                        <select id="deckFormat"
                                name="deckFormat"
                                class="form-select"
                                th:field="*{deckFormat}">
                            <option value="">Select Format</option>
                            <optgroup label="Paper Formats">
                                <option value="Standard">Standard</option>
                                <option value="Pioneer">Pioneer</option>
                                <option value="Modern">Modern</option>
                                <option value="Legacy">Legacy</option>
                                <option value="Vintage">Vintage</option>
                                <option value="Commander">Commander</option>
                                <option value="Oathbreaker">Oathbreaker</option>
                                <option value="Pauper">Pauper</option>
                                <option value="Premodern">Premodern</option>
                            </optgroup>
                            <optgroup label="Digital Formats">
                                <option value="Historic">Historic</option>
                                <option value="Timeless">Timeless</option>
                                <option value="Alchemy">Alchemy</option>
                            </optgroup>
                            <optgroup label="Casual / Special">
                                <option value="Brawl">Brawl</option>
                                <option value="Gladiator">Gladiator</option>
                                <option value="Pauper Commander">Pauper Commander</option>
                                <option value="Duel">Duel Commander</option>
                                <option value="Penny">Penny Dreadful</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="deck-columns">
                    <div th:each="entryGroup : ${groupedDecklist}" class="deck-group">
                        <h5>
                            <span th:text="${entryGroup.key}"></span>
                            (<span class="type-total"
                                   th:id="'typeTotal_' + ${entryGroup.key}"
                                   th:text="${typeQuantities[entryGroup.key]}"></span>)
                        </h5>
                        <div th:each="cardEntry : ${entryGroup.value}" class="card-row" th:data-type="${entryGroup.key}" th:data-index="${cardEntry.index}">
                            <div class="card-col-checkbox">
                                <input class="form-check-input"
                                       type="checkbox"
                                       th:id="'card_' + ${cardEntry.index}"
                                       th:name="cards[__${cardEntry.index}__].checked"
                                       th:checked="${cardEntry.card.checked}"/>
                            </div>
                            <div class="card-col-qty">
                                <input type="number"
                                       class="form-control form-control-sm quantity-input"
                                       th:data-index="${cardEntry.index}"
                                       th:id="'qty_' + ${cardEntry.index}"
                                       th:data-card-id="${cardEntry.card.id}"
                                       th:data-deck-id="${deckId}"
                                       th:data-type="${entryGroup.key}"
                                       min="1"
                                       th:value="${cardEntry.quantity}"/>
                            </div>
                            <div class="card-col-name">
                                <label class="form-check-label"
                                       th:for="'card_' + ${cardEntry.index}"
                                       th:data-quantity="${cardEntry.quantity}"
                                       th:data-name="${cardEntry.card.displayName}"
                                       th:data-card-id="${cardEntry.card.id}"
                                       th:text="${cardEntry.card.displayName}">
                                </label>
                            </div>
                            <div class="card-col-delete">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger delete-card-btn"
                                        th:data-card-id="${cardEntry.card.id}"
                                        th:data-deck-id="${deckId}">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <input type="hidden"
                                   th:name="cards[__${cardEntry.index}__].cardId"
                                   th:value="${cardEntry.card.id}"/>
                            <input type="hidden"
                                   th:name="cards[__${cardEntry.index}__].quantity"
                                   th:value="${cardEntry.quantity}"/>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<footer class="fixed-bottom bg-light border-top py-2">
    <div class="container d-flex justify-content-between align-items-center">
        <button type="submit" form="saveDeckForm" class="btn btn-success">
            Save Deck
        </button>
        <h6 class="text-muted" id="totalQuantity" th:text="'Total cards: ' + ${totalQuantity}"></h6>
        <button id="sendUncheckedBtn" type="button" class="btn btn-outline-primary">
            Send Unchecked Cards to Checklist
        </button>
        <button id="copyUncheckedBtn" type="button" class="btn btn-outline-primary">
            Copy Unchecked Cards
        </button>
        <form id="sendForm" th:action="@{/search/checklist}" method="post">
            <input type="hidden" id="cardNames" name="cardNames"/>
        </form>
    </div>
</footer>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="copyToast" class="toast text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Unchecked cards copied to clipboard.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
</body>
</html>
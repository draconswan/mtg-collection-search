<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Deck Checklist</title>
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
    />
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
            integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd"
            crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/print.css" media="print"/>
    <link rel="stylesheet" href="/css/style.css"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
    <script src="/js/mana-symbols.js" defer></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".delete-card-btn").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const cardId = btn.dataset.cardId;
                    const deckId = btn.dataset.deckId;

                    const response = await fetch(`/api/v1/decks/${deckId}/remove-card`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: `cardId=${encodeURIComponent(cardId)}`
                    });

                    if (response.ok) {
                        btn.closest(".form-check").remove();
                    } else {
                        alert("Failed to delete card.");
                    }
                });
            });
        });
        function exportUncheckedCards() {
            const includeX = document.getElementById('includeX').checked;
            const unchecked = Array.from(
                document.querySelectorAll('#saveDeckForm .form-check-input')
            )
            .filter(input => !input.checked)
            .map(input => {
                const label = input.nextElementSibling;
                const qty = label.dataset.quantity;
                const name = label.dataset.name;
                return includeX ? `${qty}x ${name}` : `${qty} ${name}`;
            });
            const outputArea = document.getElementById('outputArea');
            outputArea.value = unchecked.length > 0
                ? unchecked.join('\n')
                : "All cards are checked!";

            outputArea.select();
        }

        function clearUncheckedCards() {
            document.getElementById('outputArea').value = "";
        }

        function sendUncheckedCards() {
            const outputArea = document.getElementById('outputArea');
            const payload = outputArea.value.trim();

            if (!payload) {
                alert("There are no unchecked cards to send.");
                return;
            }

            document.getElementById('cardNames').value = payload;
            document.getElementById('sendForm').submit();
        }
    </script>
</head>
<body>
<!-- Include header -->
<div th:replace="~{fragments/header :: body}"></div>
<div class="container py-4">
    <div th:if="${cardsNotFound != null and !cardsNotFound.isEmpty()}"
         class="alert alert-danger d-flex align-items-start" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>Some cards could not be found:</strong>
            <ul class="mb-0">
                <li th:each="card : ${cardsNotFound}" th:text="${card}"></li>
            </ul>
        </div>
    </div>
    <h1 class="mb-4">Deck Checklist</h1>
    <h6 class="text-muted" th:text="'Total cards: ' + ${totalQuantity}"></h6>
    <div class="row">
        <!-- Left Column: Checklist -->
        <div class="col-md-6">
            <form id="saveDeckForm" th:action="@{/user/deck/save-deck-state}" method="post">
                <input type="hidden" name="deckId" th:value="${deckId}"/>
                <div class="row g-1">
                    <div th:each="entryGroup : ${groupedDecklist}">
                        <h5 class="mt-4 mb-2"
                            th:text="${entryGroup.key + ' (' + typeQuantities[entryGroup.key] + ')'}"></h5>
                        <div th:each="cardEntry : ${entryGroup.value}" class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   th:id="'card_' + ${cardEntry.index}"
                                   th:name="cards[__${cardEntry.index}__].checked"
                                   th:checked="${cardEntry.card.checked}"/>
                            <label class="form-check-label"
                                   th:for="'card_' + ${cardEntry.index}"
                                   th:data-quantity="${cardEntry.quantity}"
                                   th:data-name="${cardEntry.card.displayName}"
                                   th:data-card-id="${cardEntry.card.id}"
                                   th:text="${cardEntry.quantity + ' ' + cardEntry.card.displayName}">
                            </label>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger ms-2 delete-card-btn"
                                    th:data-card-id="${cardEntry.card.id}"
                                    th:data-deck-id="${deckId}">
                                <i class="bi bi-x-lg"></i>
                            </button>
                            <input type="hidden"
                                   th:name="cards[__${cardEntry.index}__].cardId"
                                   th:value="${cardEntry.card.id}"/>
                            <input type="hidden"
                                   th:name="cards[__${cardEntry.index}__].quantity"
                                   th:value="${cardEntry.quantity}"/>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Right Column: Output Text Area -->
        <div class="col-md-6">
            <div class="form-check">
                <input class="form-check-input d-not-include" type="checkbox" id="includeX"/>
                <label class="form-check-label" for="includeX">Include "x" in quantity</label>
            </div>
            <button type="submit" form="saveDeckForm" class="btn btn-success mt-2">
                Save Deck
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="exportUncheckedCards()">Export Unchecked
                Cards
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="clearUncheckedCards()">Clear</button>
            <textarea id="outputArea" class="form-control mt-2" rows="20" readonly></textarea>
            <form id="sendForm" th:action="@{/search/checklist}" method="post">
                <input type="hidden" id="cardNames" name="cardNames"/>
                <button type="button"
                        class="btn btn-outline-success mt-2"
                        onclick="sendUncheckedCards()">
                    Send Unchecked Cards to Checklist
                </button>
            </form>
        </div>
    </div>
</div>
</body>
</html>